<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>GPX + Elevation Link6</title>
<style>
  body { margin: 0; }
  #map { height: 50vh; }
  #chart { height: 50vh; }
</style>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- GPX parser -->
<script src="https://unpkg.com/leaflet-gpx"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
<div id="map"></div>
<canvas id="chart"></canvas>

<script>
// ------------------------------------------------------
// 地図の初期化
// ------------------------------------------------------
const map = L.map('map');
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 18
}).addTo(map);

// ------------------------------------------------------
// Polyline を確実に見つける関数（GPX の構造に依存しない）
// ------------------------------------------------------
function findPolyline(layer) {
  if (layer instanceof L.Polyline) return layer;

  if (layer.getLayers) {
    for (const l of layer.getLayers()) {
      const found = findPolyline(l);
      if (found) return found;
    }
  }
  return null;
}

// ------------------------------------------------------
// GPX 読み込み
// ------------------------------------------------------
const gpx = new L.GPX("2025-12-31.gpx", {
  async: true,
    polyline_options: { color: "red", weight: 4, opacity: 0.8 },
  marker_options: { startIconUrl: null, endIconUrl: null }
}).on("loaded", function(e) {

  // ルート全体が見えるように地図を調整
  map.fitBounds(e.target.getBounds());

  // ★ Polyline を確実に取得
  const polyline = findPolyline(e.target);
  const latlngs = polyline.getLatLngs();

  // 高度データ
  const elevations = latlngs.map(p => p.meta.ele);

  // グラフの X 軸ラベル（0,1,2,...）
  const labels = latlngs.map((_, i) => i);

  // ------------------------------------------------------
  // Chart.js で高度グラフを描画
  // ------------------------------------------------------
  const ctx = document.getElementById("chart").getContext("2d");
  const chart = new Chart(ctx, {
    type: "line",
    data: {
      labels: labels,
      datasets: [{
        label: "Elevation (m)",
        data: elevations,
        borderColor: "blue",
        borderWidth: 1,
        pointRadius: 0
      }]
    },
    options: {
      responsive: true,
      interaction: { mode: "index", intersect: false },
      plugins: { legend: { display: false } }
    }
  });

  // ------------------------------------------------------
  // グラフ → 地図のマウス連動
  // ------------------------------------------------------
  let marker = null;

  document.getElementById("chart").addEventListener("mousemove", function(evt) {
    const points = chart.getElementsAtEventForMode(evt, "index", { intersect: false }, false);
    if (points.length > 0) {
      const idx = points[0].index;
      const latlng = latlngs[idx];

      if (!marker) {
        marker = L.circleMarker(latlng, { radius: 6, color: "red" }).addTo(map);
      } else {
        marker.setLatLng(latlng);
      }
    }
  });
});
</script>
</body>
</html>
